<!DOCTYPE html>
<html>
	<head>
	 	<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<title>Seatmap Display</title>
		<style>
			.gridsquare {
				display: inline-table;
				border-style: solid;
				border-width: 3px;
				border-color: black;
				padding: 1%;
			}
			
			.flight-map {
				display: none;
			}
		</style>
	</head>
	<body>
		<section id="map-section"></section>
		
		<script>
			var cookieValue = document.cookie
							  .split('=')[1];
			var flight_search_offer = JSON.parse(cookieValue);
			flight_search_offer.disablePricing = true;
			flight_search_offer.paymentCardRequired = false;
			var flight_seatmap_display = {
				"data": [flight_search_offer]
			};
			
			var original_passengers = null;
			
			async function SeatmapDisplay() {
				var request_access = await RequestAccessToken();
				
				var url = "https://test.api.amadeus.com/v1/shopping/seatmaps";
				var access_token = request_access.access_token;
				var response = await fetch(url, {
					method: 'POST', 
					headers: {
						'Authorization': 'Bearer ' + access_token,
						'Content-Type': 'application/json'
					}, 
					body: JSON.stringify(flight_seatmap_display)
				});
				var json = await response.json();
				display(json);
				document.getElementById("Flight-0").style.display = "block";
				var available_seats = document.querySelectorAll(".flight-map .available");
				for (let available_seat_index = 0; available_seat_index < available_seats.length; available_seat_index++) {
					available_seats[available_seat_index].checked = false;
					available_seats[available_seat_index].addEventListener("click", () => {
						var div_tab_id = available_seats[available_seat_index].parentElement.parentElement.id;
						var passengers_remaining_h2 = document.querySelector(`#${div_tab_id} > h2`);
						var available_seats_h2 = document.querySelector(`#${div_tab_id} > h2 + h2`);		
						var passengers_remaining = parseInt(passengers_remaining_h2.innerText.substring(42));
						var num_available_seats = parseInt(available_seats_h2.innerText.substring(27));
						const inputFields = document.querySelectorAll("input");
						var all_seats_chosen = false;
						
						available_seats[available_seat_index].checked = !available_seats[available_seat_index].checked;
						if (available_seats[available_seat_index].checked) {
							available_seats[available_seat_index].style.backgroundColor = "orange";
							document.getElementById(`${div_tab_id}_${original_passengers-passengers_remaining}`).setAttribute("value", `${available_seats[available_seat_index].id}`);
							num_available_seats--;
							passengers_remaining--;
							passengers_remaining_h2.innerText = `Number of passengers to choose seats for: ${passengers_remaining}`;
							available_seats_h2.innerText = `Available seats remaining: ${num_available_seats}`;
						} else {
							available_seats[available_seat_index].style.backgroundColor = "green";
							num_available_seats++;
							passengers_remaining++;
							document.getElementById(`${div_tab_id}_${original_passengers-passengers_remaining}`).removeAttribute("value");
							passengers_remaining_h2.innerText = `Number of passengers to choose seats for: ${passengers_remaining}`;
							available_seats_h2.innerText = `Available seats remaining: ${num_available_seats}`;
						}
						const validInputs = Array.from(inputFields).filter( input => input.value !== "");
						var button = document.getElementsByTagName("button")[0];
						if (inputFields.length === validInputs.length) {
							button.style.display = "block";
						} else {
							button.style.display = "none";
						}
					});
				}
			}
			
			async function RequestAccessToken() {
				var request_access = await fetch('https://test.api.amadeus.com/v1/security/oauth2/token', {
				    method: 'POST',
				    body: new URLSearchParams({
				        'grant_type': 'client_credentials',
				        'client_id': 'OGORt5hAGLuW5GzewaxGCPFVNrKiB0WV',
				        'client_secret': 'ik6GIT6Y7ui09KcA'
				    })
				});
				var access_json = await request_access.json();
				return access_json;
			}
			
			function display(json) {
				var flights = json.data;
				var map_section = document.getElementById("map-section");
				var nav = document.createElement("nav");
				map_section.appendChild(nav);
				var form = document.createElement("form");
				var button = document.createElement("button");
				button.setAttribute("type", "submit");
				button.innerText = "Book seats!";
				button.style.display = "none";
				
				for (let flight_index in flights) {
					var tab = document.createElement("a");
					var flight = flights[flight_index];
					tab.innerText = `${flight.carrierCode} ${flight.number}, ${flight.departure.iataCode} to ${flight.arrival.iataCode}`;
					tab.setAttribute("href", `#Flight-${flight_index}`)
					nav.appendChild(tab);
					
					var div_flight = document.createElement("div");
					div_flight.setAttribute("id", `Flight-${flight_index}`);
					div_flight.className = "flight-map";
					var decks = json.data[flight_index].decks[0];
					var width = decks.deckConfiguration.width - 1;
					var length = decks.deckConfiguration.length;
					var seats = decks.seats;
					console.log(json.data);
					var passengers_remaining_h2 = document.createElement("h2");
					var passengers_remaining = seats[flight_index].travelerPricing.length;
					original_passengers = passengers_remaining;
					passengers_remaining_h2.innerText = `Number of passengers to choose seats for: ${passengers_remaining}`;
					var available_seats_h2 = document.createElement("h2");
					var available_seats = json.data[flight_index].availableSeatsCounters[0].value;
					available_seats_h2.innerText = `Available seats remaining: ${available_seats}`;

					for (var j = 0; j < passengers_remaining; j++) {
						var input = document.createElement("input");
						input.setAttribute("type", "text");
						input.setAttribute("name", `${flight_index}-${j}`);
						input.id = `Flight-${flight_index}_${j}`;
						form.appendChild(input);
					}
						
			        for(var i = 0; i < width; i++){ 
				        var row = document.createElement("div"); 
				        row.className = "row"; 
				        if (i === width/2) {
							var empty_row = document.createElement("div"); 
				        	empty_row.className = "row";
				        	div_flight.appendChild(empty_row);
						}
				        for(var x = 0; x < length; x++){ 
							if (i === width/2) {
								var empty_div = document.createElement("div");
								empty_div.className = "gridsquare";
								empty_div.innerText = "16G";
								empty_div.style.color = "white";
								empty_row.appendChild(empty_div);
							}
							var seat_index = x*width + i;
				            var cell = document.createElement("div"); 
				            cell.className = "gridsquare"; 
				            if (seats[seat_index]) {
								var seat_number = seats[seat_index].number;
								cell.innerText = `${seat_number}`;
								cell.id = `${seat_number}`;
								var availibility = seats[seat_index].travelerPricing[0].seatAvailabilityStatus;
								if (availibility === "BLOCKED") {
									cell.style.backgroundColor = "red";
								} else if (availibility === "AVAILABLE") {
									cell.style.backgroundColor = "green";
									cell.className = "gridsquare available"
								} else if (availibility === "OCCUPIED") {
									cell.style.backgroundColor = "DarkGray";
								}
							} else { //removes cells that don't have a seat index
								cell.style.display = "none";
							}
				            row.appendChild(cell);
				        } 
				        div_flight.appendChild(row); 
			      	} 
					
					tab.addEventListener("click", () => {
						var div_flights = document.getElementsByClassName("flight-map");
						for (let div_index = 0; div_index < div_flights.length; div_index++) {
							div_flights[div_index].style.display = "none";
						}
						document.getElementById(`Flight-${flight_index}`).style.display = "block";
					});
					div_flight.appendChild(passengers_remaining_h2);
					div_flight.appendChild(available_seats_h2);
					map_section.appendChild(div_flight);
				}	
				form.appendChild(button);
				map_section.appendChild(form);
			}
			
			window.onload = function() {
				SeatmapDisplay();
			}
		</script>
	</body>
</html>
