<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<title>Search Results</title>
		<meta name="viewport" content="width=device-width, initial-scale=1">
	</head>
	<body>
		<h1>no way</h1>
		<form id="form" method="GET" action="/api/price-results">
			<ol id="ol"></ol>
			<button type="submit">aight</button>
		</form>
		<script>
			var form = document.getElementById("form");
			var ol = document.getElementById("ol");
			var flights = null;
			
			//search-results?originLocationCode=IAH&destinationLocationCode=JFK&departureDate=2021-11-01&adults=1&travelClass=ECONOMY&nonStop=true&maxPrice=250
			async function search_results(query_string) {
				var request_access = await RequestAccessToken();
				
				var url = "https://test.api.amadeus.com/v2/shopping/flight-offers" + query_string + "&max=20"; //
				var access_token = request_access.access_token;
				var response = await fetch(url, {
					method: 'GET', 
					headers: {
						'Authorization': 'Bearer ' + access_token
					}
				});
				var json = await response.json();
				flights = json.data;
				var urlParams = new URLSearchParams(window.location.search);
				for (let index in flights) {
					var li = document.createElement("li");
					var radio = document.createElement("input");
					radio.setAttribute("type", "radio");
					radio.setAttribute("name", "flightSelection");
					radio.setAttribute("value", index);
					var itineraries = flights[index].itineraries;
					var grand_total = flights[index].price.grandTotal;
					var h3 = document.createElement("h3");
					h3.innerText = `Grand Total $${grand_total}`;
					li.appendChild(h3);
					for (let itinerary_index in itineraries) {
						var div_itinerary = document.createElement("div");
						var segments = itineraries[itinerary_index].segments;
						var h4_duration = document.createElement("h4");
						var total_duration = itineraries[itinerary_index].duration;
						if (itinerary_index == 0) {
							h4_duration.innerText = `Total duration to the destination: ${total_duration}`;
						} else {
							h4_duration.innerText = `Total duration back to arrival: ${total_duration}`;
						}
						div_itinerary.appendChild(h4_duration);
						var ol_segment = document.createElement("ol");
						for (let segment_index in segments) {
							var li_segment = document.createElement("li");
							var carrier = segments[segment_index].carrierCode;
							var number = segments[segment_index].number;
							var duration = segments[segment_index].duration;
							var departure_time = segments[segment_index].departure.at;
							var departure_iata = segments[segment_index].departure.iataCode;
							var arrival_time = segments[segment_index].arrival.at;
							var arrival_iata = segments[segment_index].arrival.iataCode;
							var h4 = document.createElement("h4");
							h4.innerText = `Carrier information: ${carrier} ${number}`;
							var h5 = document.createElement("h5");
							h5.innerText = `Duration for this flight: ${duration}`;
							var p_departure = document.createElement("p");
							var p_arrival = document.createElement("p");
							p_departure.innerText = `Departing from ${departure_iata} at ${departure_time}`;
							p_arrival.innerText = `Arriving at ${arrival_iata} at ${arrival_time}`;
							li_segment.appendChild(h4);
							li_segment.appendChild(h5);
							li_segment.appendChild(p_departure);
							li_segment.appendChild(p_arrival);
							ol_segment.appendChild(li_segment);
						}
						div_itinerary.appendChild(ol_segment);
						li.appendChild(div_itinerary);
					}
					li.appendChild(radio);
					ol.appendChild(li);
				}
				
			}
			
			async function RequestAccessToken() {
				var request_access = await fetch('https://test.api.amadeus.com/v1/security/oauth2/token', {
				    method: 'POST',
				    body: new URLSearchParams({
				        'grant_type': 'client_credentials',
				        'client_id': 'OGORt5hAGLuW5GzewaxGCPFVNrKiB0WV',
				        'client_secret': 'ik6GIT6Y7ui09KcA'
				    })
				});
				var access_json = await request_access.json();
				return access_json;
			}
			
			window.onload = function () {
				var query_string = window.location.search;
				search_results(query_string);
			}
			
			form.onsubmit = function () {
				var value = document.querySelector('input[name="flightSelection"]:checked').value;
				var JSON_string = JSON.stringify(flights[value]);
				document.cookie = `flight=${JSON_string}; SameSite=None; Secure`;
			}
		</script>
	</body>
</html>